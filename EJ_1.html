<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‘ì€ ì„±ì·¨ í—¬ìŠ¤ì¼€ì–´</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --muted:#9fb0ffcc;
      --text:#eaf0ff;
      --accent:#7aa2ff;
      --accent2:#66f0c2;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --line:#2a3560;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, #1b2a66 0%, rgba(27,42,102,0) 60%),
                  radial-gradient(900px 600px at 90% 20%, #0f5b6b 0%, rgba(15,91,107,0) 55%),
                  var(--bg);
      color: var(--text);
      line-height:1.45;
    }
    header{
      padding: 28px 18px 10px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: var(--shadow);
    }
    h1{margin:0; font-size: 22px; letter-spacing: -0.2px;}
    .subtitle{margin:6px 0 0; color: var(--muted); font-size: 13px;}
    main{
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px 18px 40px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: rgba(18,26,51,.92);
      border: 1px solid rgba(42,53,96,.8);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2{
      margin: 0 0 10px;
      font-size: 16px;
      letter-spacing: -0.2px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .row > *{flex:1}
    input, textarea, select{
      width:100%;
      background:#0e1530;
      border:1px solid rgba(42,53,96,.9);
      border-radius: 14px;
      padding: 11px 12px;
      color: var(--text);
      outline:none;
    }
    textarea{min-height: 76px; resize: vertical;}
    .btn{
      border: 1px solid rgba(122,162,255,.6);
      background: linear-gradient(180deg, rgba(122,162,255,.18), rgba(122,162,255,.10));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .05s ease, border-color .2s ease, background .2s ease;
      user-select:none;
    }
    .btn:hover{border-color: rgba(102,240,194,.7)}
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      border-color: rgba(159,176,255,.35);
      background: rgba(14,21,48,.6);
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border: 1px solid rgba(42,53,96,.85);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      background: rgba(14,21,48,.55);
    }
    .muted{color: var(--muted)}
    .small{font-size: 12px}
    .hr{height:1px; background: rgba(42,53,96,.7); margin: 12px 0;}
    ul{margin:10px 0 0; padding: 0 0 0 16px}
    li{margin: 6px 0;}
    .ach-list{
      list-style:none; padding:0; margin:10px 0 0;
      display:flex; flex-direction:column; gap:8px;
    }
    .ach-item{
      padding: 10px 12px;
      border: 1px solid rgba(42,53,96,.85);
      background: rgba(14,21,48,.55);
      border-radius: 14px;
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .ach-item b{font-weight:600}
    .ach-item .time{color: var(--muted); font-size: 12px; white-space:nowrap}
    .two-col{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 700px){
      .two-col{grid-template-columns:1fr}
    }
    .feedback{
      border:1px solid rgba(102,240,194,.35);
      background: rgba(102,240,194,.08);
      border-radius: 14px;
      padding: 10px 12px;
      margin-top: 10px;
      white-space: pre-wrap;
    }
    .warn{
      border-color: rgba(255,204,102,.4);
      background: rgba(255,204,102,.08);
    }
    .danger{
      border-color: rgba(255,107,107,.45);
      background: rgba(255,107,107,.08);
    }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;
    }
    .kpi .box{
      flex:1;
      min-width: 160px;
      border:1px solid rgba(42,53,96,.85);
      background: rgba(14,21,48,.55);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .kpi .num{font-size: 20px; font-weight:700}
    .kpi .lab{color: var(--muted); font-size: 12px}
    .quiz-card{
      border:1px solid rgba(42,53,96,.85);
      background: rgba(14,21,48,.55);
      border-radius: 14px;
      padding: 12px;
      margin-top: 10px;
    }
    .choice{
      display:flex; gap:8px; align-items:flex-start; margin: 8px 0;
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid rgba(42,53,96,.7);
      cursor:pointer;
    }
    .choice:hover{border-color: rgba(122,162,255,.6)}
    .choice input{margin-top: 3px; width:auto}
    footer{
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 18px 26px;
      color: var(--muted);
      font-size: 12px;
    }
    .mono{font-family: var(--mono)}
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>ì‘ì€ ì„±ì·¨ í—¬ìŠ¤ì¼€ì–´</h1>
        <p class="subtitle">
          ì‘ì€ ì„±ì·¨ â†’ ê²©ë ¤ â†’ ì§€ì† ë™ê¸° ë¶€ì—¬
        </p>
      </div>
    </div>
  </header>

  <main class="grid">
    <!-- LEFT -->
    <section class="card" aria-label="ë©”ì¸ ê¸°ëŠ¥">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <h2 style="margin:0;">1) ì‘ì€ ì„±ì·¨ ê¸°ë¡</h2>
        <span class="pill" title="Local/LLM í•˜ì´ë¸Œë¦¬ë“œ">Local + LLM API(ì˜µì…˜)</span>
      </div>

      <div class="row">
        <input id="achInput" type="text" placeholder="ì˜¤ëŠ˜ì˜ ì‘ì€ ì„±ì·¨ë¥¼ ì ì–´ë´ìš”.ê²©ë ¤ í•´ë“œë¦´ê²Œìš”!" />
        <button class="btn" id="addAchBtn">ì¶”ê°€(Add)</button>
      </div>

      <div class="two-col" style="margin-top:10px;">
        <div>
          <button class="btn secondary" id="encourageBtn">ê¸°ë¡</button>
          <button class="btn secondary" id="bellBtn">ë§‘ì€ ì¢…ì†Œë¦¬</button>
        </div>
        <div>
          <select id="toneSelect" aria-label="ê²©ë ¤ í†¤ ì„ íƒ">
            <option value="warm">ë”°ëœ»í•œ í†¤(Warm)</option>
            <option value="playful">ì¥ë‚œê¸° í†¤(Playful)</option>
            <option value="coach">ì½”ì¹˜ í†¤(Coach)</option>
          </select>
        </div>
      </div>

      <div class="feedback" id="encourageBox" role="status" aria-live="polite">
        ì—¬ê¸°ì— ê²©ë ¤ ë©˜íŠ¸ê°€ í‘œì‹œë¼ìš”.
      </div>

      <div class="kpi" aria-label="ìœ ì§€ ì§€í‘œ(ê°„ë‹¨)">
        <div class="box">
          <div class="num" id="kpiCount">0</div>
          <div class="lab">ê¸°ë¡ ê°œìˆ˜(Count)</div>
        </div>
        <div class="box">
          <div class="num" id="kpiStreak">0</div>
          <div class="lab">ì—°ì† ê¸°ë¡(Streak, day)</div>
        </div>
        <div class="box">
          <div class="num" id="kpiToday">0</div>
          <div class="lab">ì˜¤ëŠ˜ ê¸°ë¡(Today)</div>
        </div>
      </div>

      <div class="hr"></div>

      <h2>ìŠ¤íŠ¸ë ˆìŠ¤ í•´ì†Œë²• & ëŒ€ì²˜ ì¡°ì–¸</h2>
      <p class="muted small">
        â€» ì´ í˜ì´ì§€ëŠ” êµìœ¡/í”„ë¡œí† íƒ€ì…ì´ë©° ì˜ë£Œ/ì¹˜ë£Œ ì¡°ì–¸ì´ ì•„ë‹ˆì—ìš”. ì¦ìƒì´ ì‹¬í•˜ê±°ë‚˜ ì˜¤ë˜ ì§€ì†ë˜ë©´ ì „ë¬¸ê°€(ì˜ì‚¬/ìƒë‹´ì‚¬) ë„ì›€ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
      </p>

      <div class="two-col">
        <div class="card" style="padding:12px; background: rgb(20, 140, 160); border-radius:14px; border:1px solid rgba(255, 180, 0, 0.6); box-shadow:none;">
          <b> </b>
          <ul id="tipsList">
            <li>4-6 í˜¸í¡(Breathing): 4ì´ˆ ë“¤ì´ë§ˆì‹œê³  6ì´ˆ ë‚´ì‰¬ê¸° Ã— 5íšŒ</li>
            <li>ëª¸ ìŠ¤ìº”(Body scan): ì–´ê¹¨/í„± í˜ì„ 10%ë§Œ í’€ê¸°</li>
            <li>ë¯¸ë‹ˆ ì‚°ì±…(Mini walk): 3ë¶„ë§Œ ë°–ì„ ë³´ê³  ê±·ê¸°</li>
            <li>ë¬¼ í•œ ì»µ(Water): í•œ ë²ˆì— ì²œì²œíˆ ë§ˆì‹œê¸°</li>
          </ul>
          <div class="row" style="margin-top:10px;">
            <button class="btn secondary" id="randomTipBtn">ëœë¤</button>
            <button class="btn secondary" id="breathBtn">í˜¸í¡ íƒ€ì´ë¨¸(60ì´ˆ)</button>
          </div>
          <div class="feedback warn" id="tipBox" aria-live="polite">ì—¬ê¸°ì— ëœë¤ íŒì´ ë‚˜ì™€ìš”.</div>
        </div>

        <div class="card" style="padding:12px; background: rgba(20,140,160); border-radius:14px; border:1px solid rgba(255, 180, 0, 0.6); box-shadow:none;">
          <b>ìŠ¤íŠ¸ë ˆìŠ¤ ìƒí™©ë³„ ì¡°ì–¸</b>
          <p class="muted small" style="margin-top:7px;">
            â€œì €í¬ëŠ” ì–¸ì œë‚˜ ë‹¹ì‹ ì˜ í¸ì´ì—ìš”"
          </p>
          <textarea id="stressInput" placeholder="ì§€ê¸ˆ ìƒí™©ì„ í•œ ì¤„ë¡œ ì ì–´ë´ìš”. "></textarea>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="adviceBtn">ì¡°ì–¸ ë°›ê¸°</button>
            <button class="btn secondary" id="clearAdviceBtn">ì´ˆê¸°í™”</button>
          </div>
          <div class="feedback" id="adviceBox" aria-live="polite">ì—¬ê¸°ì— ì¡°ì–¸ì´ í‘œì‹œë¼ìš”.</div>
        </div>
      </div>

      <div class="hr"></div>

      <h2>ì‹œë‚˜ë¦¬ì˜¤ í€´ì¦ˆ(Scenario Quiz)</h2>
      <p class="muted small">
        ì •ë‹µì´ ìˆëŠ” í€´ì¦ˆ(Answer-key) + ê¸ì • í”¼ë“œë°±(Positive feedback) ë°©ì‹ì…ë‹ˆë‹¤.
      </p>

      <div id="quizArea"></div>
      <div class="feedback" id="quizResult" aria-live="polite">í€´ì¦ˆë¥¼ í’€ë©´ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë‚˜ì™€ìš”.</div>
    </section>

    <!-- RIGHT -->
    <aside class="card" aria-label="ì„¤ì •/ê°œë°œ ë©”ëª¨">
      <h2>ê°œë°œ ë©”ëª¨(Dev Notes)</h2>
      <p class="muted small">
        ê²©ë ¤ ë©˜íŠ¸ëŠ” í˜„ì¬ <b>ë¡œì»¬ ë£° ê¸°ë°˜(Rule-based)</b>ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤. ì¶”í›„ Hugging Face LLMì„ ë¶™ì¼ ë•ŒëŠ”
        ì•„ë˜ <span class="mono">useLLM</span> ì˜µì…˜ì„ ì¼œê³  API í˜¸ì¶œì„ êµì²´í•˜ì„¸ìš”.
      </p>

      <div class="hr"></div>

      <h2>LLM ì—°ê²° ë°©ì‹ ë¹„êµ</h2>
      <table style="width:100%; border-collapse:collapse; font-size:12px;">
        <thead>
          <tr>
            <th style="text-align:left; border-bottom:1px solid rgba(42,53,96,.7); padding:8px 6px;">ë°©ì‹</th>
            <th style="text-align:left; border-bottom:1px solid rgba(42,53,96,.7); padding:8px 6px;">ì¥ì </th>
            <th style="text-align:left; border-bottom:1px solid rgba(42,53,96,.7); padding:8px 6px;">ì£¼ì˜</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="padding:8px 6px; border-bottom:1px solid rgba(42,53,96,.4);">ë£° ê¸°ë°˜<br>(Rule-based)</td>
            <td style="padding:8px 6px; border-bottom:1px solid rgba(42,53,96,.4);">ë¹ ë¥´ê³  ì•ˆì •ì </td>
            <td style="padding:8px 6px; border-bottom:1px solid rgba(42,53,96,.4);">í‘œí˜„ ë‹¤ì–‘ì„± ì œí•œ</td>
          </tr>
          <tr>
            <td style="padding:8px 6px; border-bottom:1px solid rgba(42,53,96,.4);">LLM API<br>(Hugging Face)</td>
            <td style="padding:8px 6px; border-bottom:1px solid rgba(42,53,96,.4);">ìì—°ìŠ¤ëŸ¬ìš´ ê²©ë ¤, ê°œì¸í™”</td>
            <td style="padding:8px 6px; border-bottom:1px solid rgba(42,53,96,.4);">í† í°/ë¹„ìš©, ì•ˆì „ í•„í„°, í‚¤ ë³´ì•ˆ</td>
          </tr>
        </tbody>
      </table>

      <div class="hr"></div>

      <h2>ë³´ì•ˆ íŒ(Security)</h2>
      <ul class="small muted">
        <li>API í† í°(Token)ì€ <b>í”„ë¡ íŠ¸(HTML)</b>ì— ë„£ì§€ ë§ê³ , ë°±ì—”ë“œ(Backend)ì—ì„œ í”„ë¡ì‹œ(Proxy) ê¶Œì¥</li>
        <li>ë¯¼ê°ì •ë³´(PII)ëŠ” ì…ë ¥í•˜ì§€ ì•Šë„ë¡ ì•ˆë‚´</li>
      </ul>

      <div class="hr"></div>

      <h2>ê¸´ê¸‰ ì•ˆë‚´</h2>
      <div class="feedback danger">
        ì§€ê¸ˆ ë§¤ìš° ìœ„í—˜í•˜ê±°ë‚˜ ì¦‰ì‹œ ë„ì›€ì´ í•„ìš”í•˜ë‹¤ë©´, ê°€ê¹Œìš´ ì‘ê¸‰ ì„œë¹„ìŠ¤/ì§€ì—­ ë„ì›€ ê¸°ê´€ì— ì—°ë½í•˜ì„¸ìš”.
        (ì´ ì•±ì€ ì˜ë£Œ ì‘ê¸‰ ëŒ€ì‘ ë„êµ¬ê°€ ì•„ë‹™ë‹ˆë‹¤.)
      </div>
    </aside>
  </main>

  <footer>
    <div>Â© Prototype â€” â€œì •ì‹ : ê¹€ì€ì¤‘â€ (HTML/CSS/JS) Â· Web Audio APIë¡œ ì¢…ì†Œë¦¬ ìƒì„±</div>
  </footer>

<script>
/**
 * ì •ì‹ : ê¹€ì€ì¤‘ â€” ë‹¨ì¼ í˜ì´ì§€ í”„ë¡œí† íƒ€ì…
 * - Local ê²©ë ¤ ë©˜íŠ¸(ê¸°ë³¸)
 * - Hugging Face LLM API(ì˜µì…˜): useLLM=true + callLLM() êµ¬í˜„ êµì²´
 */

// -------------------------
// State (ìƒíƒœ)
// -------------------------
const state = {
  achievements: loadJSON("achievements", []),
  lastActiveDate: loadJSON("lastActiveDate", null),
  streak: loadJSON("streak", 0),
  useLLM: false, // <-- LLMì„ ë¶™ì´ë©´ trueë¡œ
  // ì•„ë˜ëŠ” ì˜ˆì‹œìš©(ì‹¤ì‚¬ìš© ê¸ˆì§€): í”„ë¡ íŠ¸ì— í† í° ë„£ì§€ ë§ˆì„¸ìš”.
  hfEndpoint: "", // ì˜ˆ: "https://api-inference.huggingface.co/models/yourname/yourmodel"
};

// -------------------------
// UI refs
// -------------------------
const achInput = document.getElementById("achInput");
const addAchBtn = document.getElementById("addAchBtn");
const encourageBtn = document.getElementById("encourageBtn");
const bellBtn = document.getElementById("bellBtn");
const toneSelect = document.getElementById("toneSelect");
const encourageBox = document.getElementById("encourageBox");
const achListEl = document.createElement("ul");
achListEl.className = "ach-list";
encourageBox.parentElement.insertBefore(achListEl, encourageBox.nextSibling);

const kpiCount = document.getElementById("kpiCount");
const kpiStreak = document.getElementById("kpiStreak");
const kpiToday = document.getElementById("kpiToday");

const randomTipBtn = document.getElementById("randomTipBtn");
const breathBtn = document.getElementById("breathBtn");
const tipBox = document.getElementById("tipBox");

const stressInput = document.getElementById("stressInput");
const adviceBtn = document.getElementById("adviceBtn");
const clearAdviceBtn = document.getElementById("clearAdviceBtn");
const adviceBox = document.getElementById("adviceBox");

const quizArea = document.getElementById("quizArea");
const quizResult = document.getElementById("quizResult");

// -------------------------
// Helpers
// -------------------------
function nowISO(){ return new Date().toISOString(); }
function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function formatTime(iso){
  const d = new Date(iso);
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${todayKey()} ${hh}:${mm}`;
}
function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch(e){ return fallback; }
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

// -------------------------
// Streak logic (ì—°ì† ê¸°ë¡)
// -------------------------
function updateStreakOnAdd(){
  const today = todayKey();
  const last = state.lastActiveDate;

  if(!last){
    state.streak = 1;
  } else {
    const lastDate = new Date(last);
    const todayDate = new Date(today);
    const diffDays = Math.floor((todayDate - lastDate) / (1000*60*60*24));
    if(diffDays === 0){
      // already counted today
    } else if(diffDays === 1){
      state.streak += 1;
    } else {
      state.streak = 1;
    }
  }
  state.lastActiveDate = today;
  saveJSON("streak", state.streak);
  saveJSON("lastActiveDate", state.lastActiveDate);
}

// -------------------------
// Encourage messages (ê²©ë ¤ ë©˜íŠ¸) - Local
// -------------------------
const encourageTemplates = {
  warm: [
    "ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”? â€œ{ach}â€ â€” ì˜¤ëŠ˜ì˜ ë‚˜ë¥¼ ì˜ ì±™ê²¼ì–´ìš”.\nì‘ì€ ì„±ì·¨ê°€ ìŒ“ì´ë©´ í° ìì‹ ê°ì´ ë¼ìš”. ì§€ê¸ˆ í˜ì´ìŠ¤ ê·¸ëŒ€ë¡œ ê°€ë©´ ë©ë‹ˆë‹¤.",
    "â€œ{ach}â€ í–ˆë‹¤ëŠ” ê±´, ì´ë¯¸ ë°©í–¥ì„ ì¡ì•˜ë‹¤ëŠ” ëœ»ì´ì—ìš”.\nì™„ë²½ì´ ì•„ë‹ˆë¼ ì§€ì†(Consistency)ì´ í•µì‹¬! ì˜¤ëŠ˜ë„ í•œ ì¹¸ ì „ì§„í–ˆì–´ìš”.",
    "ì˜¤ëŠ˜ì˜ í•œ ì¤„: â€œ{ach}â€.\nì€ì¤‘ë‹˜, ì´ ì •ë„ë©´ ì¶©ë¶„íˆ ì˜í•˜ê³  ìˆì–´ìš”. ë‹¤ìŒì€ â€˜ê°™ì€ í¬ê¸°â€™ë¡œ í•œ ë²ˆ ë”ë§Œ!"
  ],
  playful: [
    "ì˜¤ì¼€ì´! â€œ{ach}â€ ë‹¬ì„±!\nì´ê±´ â€˜ë ˆë²¨ì—… ê²½í—˜ì¹˜â€™ê°€ í™•ì‹¤íˆ ìŒ“ì´ëŠ” í–‰ë™ì…ë‹ˆë‹¤. ğŸ®",
    "â€œ{ach}â€ë¼ë‹ˆâ€¦ ì˜¤ëŠ˜ì˜ MVPëŠ” ì€ì¤‘ë‹˜.\në‚´ì¼ì˜ ë‚˜: â€œì™€, ê³ ë§ˆì›Œ.â€",
    "ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”?\nâ€œ{ach}â€ â†’ (ë‘ë‘¥) â€˜ìê¸°íš¨ëŠ¥ê°(Self-efficacy)â€™ ìƒìŠ¹!"
  ],
  coach: [
    "ì¢‹ìŠµë‹ˆë‹¤. â€œ{ach}â€ëŠ” â€˜ì‹¤í–‰(Action)â€™ì´ ë“¤ì–´ê°„ ê¸°ë¡ì´ì—ìš”.\në‹¤ìŒ ëª©í‘œëŠ” ì‘ê²Œ: 1) ê°™ì€ í–‰ë™ 2) ë” ì§§ê²Œ 3) ë” ì‰½ê²Œ. ìœ ì§€(Adherence)ë¥¼ ìµœìš°ì„ !",
    "â€œ{ach}â€ ì™„ë£Œ.\nì˜¤ëŠ˜ì˜ í¬ì¸íŠ¸: â€˜ì‹œì‘í–ˆëŠ”ê°€â€™ê°€ ì „ë¶€ì…ë‹ˆë‹¤. ë‚´ì¼ë„ 60ì´ˆë§Œì´ë¼ë„ ë‹¤ì‹œ í•´ë´…ì‹œë‹¤.",
    "ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”?\nì´ê±¸ ë£¨í‹´(Routine)ìœ¼ë¡œ ë§Œë“¤ë ¤ë©´: íŠ¸ë¦¬ê±°(Trigger) í•˜ë‚˜ë§Œ ì •í•˜ì„¸ìš”. ì˜ˆ: ì‹í›„ 3ë¶„."
  ]
};

function buildEncourageLocal(latestAch, tone){
  const t = encourageTemplates[tone] ? tone : "warm";
  const msg = pick(encourageTemplates[t]).replaceAll("{ach}", latestAch || "ì‘ì€ í–‰ë™ í•˜ë‚˜");
  const extra = "\n\nâœ… ì˜¤ëŠ˜ì˜ ì œì•ˆ: â€˜ë„ˆë¬´ ì‘ê²Œâ€™ ì„¤ì •í•´ë„ ë©ë‹ˆë‹¤. (ì˜ˆ: 30ì´ˆ ì •ë¦¬, ë¬¼ 3ëª¨ê¸ˆ)";
  return msg + extra;
}

// -------------------------
// Advice (ìŠ¤íŠ¸ë ˆìŠ¤ ëŒ€ì²˜) - Local
// -------------------------
function buildAdviceLocal(text){
  const basePositive = "ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”? ì§€ê¸ˆ ì´ë ‡ê²Œ â€˜ìƒí™©ì„ ë§ë¡œ ì •ë¦¬â€™í•œ ê²ƒë¶€í„° ì´ë¯¸ í° ì§„ì „ì´ì—ìš”.\n";
  const normalized = (text || "").trim();
  if(!normalized){
    return basePositive + "í•œ ì¤„ë§Œ ë” ì ì–´ì¤˜ìš”. ì˜ˆ: â€œë¬´ì—‡ ë•Œë¬¸ì—/ì–¸ì œ/ì–´ë–¤ ëŠë‚Œì¸ì§€â€";
  }

  // Simple pattern routing (ë§¤ìš° ë‹¨ìˆœí•œ ë£° ê¸°ë°˜)
  const lower = normalized.toLowerCase();

  const modules = [];

  // 1) validation (ì •ì„œ í™•ì¸)
  modules.push("1) ê°ì • ë¼ë²¨ë§(Emotion labeling): ì§€ê¸ˆ ëŠë¼ëŠ” ê°ì •ì„ â€˜í•œ ë‹¨ì–´â€™ë¡œ ë¶™ì—¬ë´ìš”. ì˜ˆ: ë¶ˆì•ˆ/ê¸´ì¥/ì§œì¦/ë¬´ê¸°ë ¥");

  // 2) action (í–‰ë™)
  if(lower.includes("ë°œí‘œ") || lower.includes("ì‹œí—˜") || lower.includes("ë©´ì ‘")){
    modules.push("2) 10ë¶„ ê³„íš(10-minute plan):\n- 3ë¶„: í•  ì¼ 3ê°œë§Œ ì ê¸°\n- 5ë¶„: ê°€ì¥ ì‰¬ìš´ 1ê°œë§Œ ì‹œì‘\n- 2ë¶„: ë‹¤ìŒ í–‰ë™ì„ â€˜ë‚´ì¼/ì˜¤ëŠ˜â€™ë¡œ ì˜ˆì•½");
  } else if(lower.includes("ê´€ê³„") || lower.includes("ì¹œêµ¬") || lower.includes("ê°€ì¡±") || lower.includes("ìƒì‚¬")){
    modules.push("2) ê²½ê³„ ì„¤ì •(Boundary):\n- â€˜ì‚¬ì‹¤(Fact)â€™ê³¼ â€˜í•´ì„(Interpretation)â€™ì„ ë¶„ë¦¬\n- ìš”ì²­ ë¬¸ì¥ í…œí”Œë¦¿: â€œì§€ê¸ˆì€ ì–´ë ¤ì›Œìš”. ëŒ€ì‹  (ëŒ€ì•ˆ)ì„ í• ê²Œìš”.â€");
  } else {
    modules.push("2) ì¦‰ì‹œ ì™„í™”(Immediate relief): 4-6 í˜¸í¡ 5íšŒ + ì–´ê¹¨ í˜ 10% ë¹¼ê¸° + ë¬¼ í•œ ì»µ");
  }

  // 3) reframe (ì¬êµ¬ì„±)
  modules.push("3) ì¬êµ¬ì„±(Reframe): â€œì§€ê¸ˆ ì´ ìŠ¤íŠ¸ë ˆìŠ¤ëŠ” ë‚´ê°€ ì¤‘ìš”í•˜ê²Œ ì—¬ê¸°ëŠ” ê²ƒ(ê°€ì¹˜, Value)ì´ ìˆë‹¤ëŠ” ì‹ í˜¸â€ë¼ê³  í•´ì„í•´ë„ ì¢‹ì•„ìš”.");

  // 4) safety note
  modules.push("4) ì°¸ê³ (Notice): ë¶ˆë©´/ê³µí™©/ìš°ìš¸ì´ 2ì£¼ ì´ìƒ ì§€ì†ë˜ê±°ë‚˜ ì¼ìƒ ê¸°ëŠ¥ì´ í¬ê²Œ ë–¨ì–´ì§€ë©´ ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.");

  return (
    basePositive +
    `\nğŸ“Œ ë‹¹ì‹ ì˜ ìƒí™©: â€œ${normalized}â€\n\n` +
    modules.join("\n\n")
  );
}

// -------------------------
// Tips (ëœë¤ íŒ)
// -------------------------
const tips = [
  "ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”? ì§€ê¸ˆì€ 4-6 í˜¸í¡(Breathing) 5íšŒë§Œ í•´ë„ ì¶©ë¶„í•©ë‹ˆë‹¤.",
  "ëˆˆì„ ì°½ë°–ìœ¼ë¡œ 20ì´ˆë§Œ ë‘ì„¸ìš”. ì‹œì•¼ë¥¼ â€˜ë©€ë¦¬â€™ ë‘ë©´ ê¸´ì¥ì´ ë‚´ë ¤ê°‘ë‹ˆë‹¤.",
  "ì†ë°”ë‹¥ ë§ˆì°° 10ì´ˆ + ë”°ëœ»í•œ ê°ê° ëŠë¼ê¸°(grounding). ì§€ê¸ˆ-ì—¬ê¸°ì— ë¶™ëŠ” ì—°ìŠµì´ì—ìš”.",
  "í•  ì¼ì„ â€˜1ë¶„ ë²„ì „â€™ìœ¼ë¡œ ì¤„ì—¬ë³´ì„¸ìš”. ì‹œì‘ì´ ê³§ ìŠ¹ë¦¬ì…ë‹ˆë‹¤.",
  "ìŠ¤íŠ¸ë ˆìŠ¤ëŠ” â€˜ì—ë„ˆì§€â€™ì¼ ë•Œê°€ ë§ì•„ìš”. 30ì´ˆ ìŠ¤íŠ¸ë ˆì¹­ìœ¼ë¡œ ë°°ì¶œí•´ë´…ì‹œë‹¤."
];

function startBreathTimer(){
  const total = 60; // seconds
  let t = 0;
  tipBox.textContent = "í˜¸í¡ ì‹œì‘! 4ì´ˆ ë“¤ì´ë§ˆì‹œê³  6ì´ˆ ë‚´ì‰¬ê¸°. (ì´ 60ì´ˆ)";
  const id = setInterval(()=>{
    t++;
    const remain = total - t;
    if(remain <= 0){
      clearInterval(id);
      tipBox.textContent = "ë! ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”? ì§€ê¸ˆ ìƒíƒœê°€ â€˜ì¡°ê¸ˆâ€™ë§Œ ë” ë‚˜ì•„ì¡Œìœ¼ë©´ ì„±ê³µì…ë‹ˆë‹¤.";
    }
  }, 1000);
}

// -------------------------
// Web Audio Chime (ì¢…ì†Œë¦¬)
// -------------------------
let audioCtx = null;
function playChime(){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const t0 = audioCtx.currentTime;

    // 3 partials for a simple bell-like sound
    const freqs = [880, 1320, 1760];
    freqs.forEach((f, i)=>{
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(f, t0);

      // envelope
      const start = t0 + i*0.01;
      g.gain.setValueAtTime(0.0001, start);
      g.gain.exponentialRampToValueAtTime(0.25/(i+1), start + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, start + 1.3);

      o.connect(g).connect(audioCtx.destination);
      o.start(start);
      o.stop(start + 1.35);
    });
  }catch(e){
    alert("ì¢…ì†Œë¦¬ ì¬ìƒì´ ë¸Œë¼ìš°ì €ì—ì„œ ì°¨ë‹¨ë  ìˆ˜ ìˆì–´ìš”. ë²„íŠ¼ì„ í•œ ë²ˆ ë” ëˆŒëŸ¬ë³´ì„¸ìš”.");
  }
}

// -------------------------
// Quiz (ì‹œë‚˜ë¦¬ì˜¤ í€´ì¦ˆ)
// -------------------------
const quiz = [
  {
    q: "ë‚´ì¼ ë°œí‘œê°€ ìˆëŠ”ë° ë¶ˆì•ˆí•´ì„œ ì•„ë¬´ê²ƒë„ ëª» í•˜ê² ì–´ìš”. ì²« í–‰ë™ìœ¼ë¡œ ê°€ì¥ ì¢‹ì€ ê±´?",
    a: [
      { text: "ì™„ë²½í•œ ìë£Œë¥¼ í•œ ë²ˆì— ëë‚´ë ¤ê³  ë°¤ìƒˆê¸°", ok:false,
        why:"ì—´ì‹¬ ì˜ì§€ëŠ” ìµœê³ ì˜ˆìš”! ë‹¤ë§Œ ìˆ˜ë©´ ë¶€ì¡±ì€ ë¶ˆì•ˆì„ ë” í‚¤ìš¸ ìˆ˜ ìˆì–´ìš”. â€˜ì‘ê²Œ ì‹œì‘â€™ì´ ë” íš¨ìœ¨ì ì…ë‹ˆë‹¤." },
      { text: "3ë¶„ë§Œì— í•  ì¼ 3ê°œë¥¼ ì ê³ , ê°€ì¥ ì‰¬ìš´ 1ê°œë¥¼ 5ë¶„ë§Œ ì‹œì‘í•˜ê¸°", ok:true,
        why:"ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”? ë¶ˆì•ˆì„ â€˜í–‰ë™â€™ìœ¼ë¡œ ë°”ê¾¸ëŠ” ìµœê³ ì˜ ìŠ¤íƒ€íŠ¸ì…ë‹ˆë‹¤." },
      { text: "ë¶ˆì•ˆì´ ì‚¬ë¼ì§ˆ ë•Œê¹Œì§€ ì•„ë¬´ê²ƒë„ ì•ˆ í•˜ê³  ê¸°ë‹¤ë¦¬ê¸°", ok:false,
        why:"ê¸°ë‹¤ë¦¬ëŠ” ê²ƒë„ ìê¸°ë³´í˜¸ì¼ ìˆ˜ ìˆì–´ìš”. ë‹¤ë§Œ ë¶ˆì•ˆì€ â€˜í–‰ë™ í›„â€™ ì¤„ì–´ë“œëŠ” ê²½ìš°ê°€ ë§ì•„ìš”." }
    ]
  },
  {
    q: "ìŠ¤íŠ¸ë ˆìŠ¤ ë•Œë¬¸ì— ìê¾¸ ìŠ¤ë§ˆíŠ¸í°ì„ ê³„ì† ë³´ê²Œ ë¼ìš”. ëŒ€ì•ˆìœ¼ë¡œ ë” ì¢‹ì€ ì„ íƒì€?",
    a: [
      { text: "í°ì„ ì•„ì˜ˆ ì—†ì• ê¸°(ê·¹ë‹¨ì ìœ¼ë¡œ ì°¨ë‹¨)", ok:false,
        why:"ê²°ë‹¨ë ¥ì€ ë©‹ì ¸ìš”! ê·¸ëŸ°ë° ì§€ì†(Adherence)ì´ ì–´ë µë‹¤ë©´ ë°˜ë™ì´ ì˜¬ ìˆ˜ ìˆì–´ìš”." },
      { text: "â€˜2ë¶„ë§Œâ€™ í° ë‚´ë ¤ë†“ê³  ë¬¼ ë§ˆì‹œê¸° + ì–´ê¹¨ í˜ 10% ë¹¼ê¸°", ok:true,
        why:"ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”? ì‘ê³  êµ¬ì²´ì ì´ë¼ ê¾¸ì¤€íˆ ìœ ì§€í•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤." },
      { text: "ìì±…í•˜ë©´ì„œ ë” ì˜ì§€ë¡œ ë²„í‹°ê¸°", ok:false,
        why:"ì˜ì§€ë„ ì¤‘ìš”í•˜ì§€ë§Œ, ìì±…ì€ íšŒë³µì„ ë°©í•´í•´ìš”. â€˜í™˜ê²½/í–‰ë™â€™ ì¡°ì •ì´ ë” ì•ˆì „í•©ë‹ˆë‹¤." }
    ]
  },
  {
    q: "ìƒëŒ€ê°€ ë‚˜ë¥¼ ë¬´ì‹œí•œ ê²ƒ ê°™ì•„ í™”ê°€ ë‚˜ìš”. ê°€ì¥ ê±´ê°•í•œ ì²« ëŒ€ì‘ì€?",
    a: [
      { text: "ì¦‰ì‹œ ë”°ì§€ë©° ê³µê²©ì ìœ¼ë¡œ ë§í•˜ê¸°", ok:false,
        why:"ê°ì •ì´ ê°•í• ìˆ˜ë¡ ì¦‰ì‹œ ë°˜ì‘í•˜ê³  ì‹¶ì£ . ë‹¤ë§Œ ê´€ê³„ ë¹„ìš©ì´ ì»¤ì§ˆ ìˆ˜ ìˆì–´ìš”." },
      { text: "ì‚¬ì‹¤(Fact)ê³¼ í•´ì„(Interpretation)ì„ ë¶„ë¦¬í•´ ì ê³ , ì°¨ë¶„í•  ë•Œ ìš”ì²­ì„ ë§í•˜ê¸°", ok:true,
        why:"ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”? ê°ì •ì„ ì¡´ì¤‘í•˜ë©´ì„œë„ ê´€ê³„ë¥¼ ì§€í‚¤ëŠ” ë°©ì‹ì…ë‹ˆë‹¤." },
      { text: "ì•„ë¬´ ë§ë„ ì•ˆ í•˜ê³  ê³„ì† ì°¸ê¸°", ok:false,
        why:"ì°¸ëŠ” ê²ƒë„ ì „ëµì¼ ìˆ˜ ìˆì–´ìš”. ë‹¤ë§Œ ì¥ê¸°ì ìœ¼ë¡œëŠ” ê²½ê³„(Boundary) í‘œí˜„ì´ í•„ìš”í•  ìˆ˜ ìˆì–´ìš”." }
    ]
  }
];

function renderQuiz(){
  quizArea.innerHTML = "";
  quiz.forEach((item, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "quiz-card";

    const title = document.createElement("div");
    title.innerHTML = `<b>Q${idx+1}.</b> ${item.q}`;
    wrap.appendChild(title);

    item.a.forEach((c, j)=>{
      const label = document.createElement("label");
      label.className = "choice";
      label.innerHTML = `
        <input type="radio" name="q${idx}" value="${j}" />
        <div>${c.text}</div>
      `;
      label.addEventListener("click", ()=>{
        const radios = wrap.querySelectorAll(`input[name="q${idx}"]`);
        radios.forEach(r => r.checked = false);
        label.querySelector("input").checked = true;
        showQuizResult();
      });
      wrap.appendChild(label);
    });

    quizArea.appendChild(wrap);
  });
}

function showQuizResult(){
  let answered = 0;
  let correct = 0;
  let out = [];

  quiz.forEach((item, idx)=>{
    const pickedEl = document.querySelector(`input[name="q${idx}"]:checked`);
    if(!pickedEl) return;
    answered++;
    const pickIdx = Number(pickedEl.value);
    const choice = item.a[pickIdx];
    if(choice.ok) correct++;

    const mark = choice.ok ? "âœ…" : "ğŸŸ¡";
    out.push(`${mark} Q${idx+1}: ${choice.why}`);
  });

  if(answered === 0){
    quizResult.textContent = "ì•„ì§ ì„ íƒí•œ ë‹µì´ ì—†ì–´ìš”. í•˜ë‚˜ë§Œ ê³¨ë¼ë„ ì¢‹ì•„ìš”!";
    return;
  }

  const score = Math.round((correct / quiz.length) * 100);
  // â€œë¬´ì¡°ê±´ ê¸ì •â€ í†¤: ì ìˆ˜ë„ ì••ë°• ì—†ì´ ì•ˆë‚´
  quizResult.textContent =
    `ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”?\n` +
    `ì§„í–‰: ${answered}/${quiz.length} Â· ì •ë‹µ(Recommended) ì„ íƒ: ${correct}\n` +
    `ì²´ê° ì ìˆ˜(Score): ${score}ì  (ì ìˆ˜ëŠ” ì°¸ê³ ìš©!)\n\n` +
    out.join("\n\n");
}

// -------------------------
// Achievements UI
// -------------------------
function addAchievement(text){
  const t = (text || "").trim();
  if(!t) return;

  state.achievements.unshift({ text: t, at: nowISO(), day: todayKey() });
  saveJSON("achievements", state.achievements);

  updateStreakOnAdd();
  renderAchievements();
  updateKPIs();

  achInput.value = "";
  encourageBox.textContent = buildEncourageLocal(t, toneSelect.value);
}

function renderAchievements(){
  achListEl.innerHTML = "";
  const items = state.achievements.slice(0, 12);
  items.forEach((it, idx)=>{
    const li = document.createElement("li");
    li.className = "ach-item";
    li.innerHTML = `
      <div>
        <b>${escapeHTML(it.text)}</b>
        <div class="muted small">í´ë¦­í•˜ë©´ ê²©ë ¤ë¥¼ ë‹¤ì‹œ ë°›ì„ ìˆ˜ ìˆì–´ìš”.</div>
      </div>
      <div class="time">${formatTime(it.at)}</div>
    `;
    li.addEventListener("click", ()=>{
      encourageBox.textContent = buildEncourageLocal(it.text, toneSelect.value);
      playChime();
    });

    // delete button (optional)
    const del = document.createElement("button");
    del.className = "btn secondary";
    del.style.padding = "8px 10px";
    del.textContent = "ì‚­ì œ";
    del.addEventListener("click", (e)=>{
      e.stopPropagation();
      state.achievements.splice(state.achievements.indexOf(it), 1);
      saveJSON("achievements", state.achievements);
      renderAchievements();
      updateKPIs();
      encourageBox.textContent = "ì‚­ì œ ì™„ë£Œ! ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”? ì •ë¦¬í•˜ëŠ” ê²ƒë„ í›Œë¥­í•œ ì„±ì·¨ì…ë‹ˆë‹¤.";
    });
    li.appendChild(del);

    achListEl.appendChild(li);
  });
}

function updateKPIs(){
  kpiCount.textContent = state.achievements.length;

  // today count
  const tk = todayKey();
  const todayCount = state.achievements.filter(x => x.day === tk).length;
  kpiToday.textContent = todayCount;

  // streak
  kpiStreak.textContent = state.streak || 0;
}

function escapeHTML(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

// -------------------------
// Optional: Hugging Face LLM (ì˜µì…˜)
// -------------------------
async function callLLM(promptText){
  // âœ… ê¶Œì¥: ë°±ì—”ë“œ(Backend)ì—ì„œ í† í° ê´€ë¦¬ + í”„ë¡ì‹œ(Proxy)
  // ì—¬ê¸°ì„œëŠ” êµ¬ì¡°ë§Œ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤.
  if(!state.hfEndpoint){
    throw new Error("HF endpointê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
  }

  // ì˜ˆì‹œ ìŠ¤ì¼ˆë ˆí†¤(í”„ë¡ íŠ¸ í† í° ê¸ˆì§€):
  // const res = await fetch("/api/encourage", { method:"POST", headers:{...}, body: JSON.stringify({prompt: promptText}) });
  // const data = await res.json();
  // return data.text;

  // ì„ì‹œ:
  return "LLM ì‘ë‹µ(placeholder): ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”?";
}

// -------------------------
// Events
// -------------------------
addAchBtn.addEventListener("click", ()=> addAchievement(achInput.value));
achInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter") addAchievement(achInput.value);
});

encourageBtn.addEventListener("click", async ()=>{
  const latest = state.achievements[0]?.text || achInput.value.trim();
  const tone = toneSelect.value;

  if(!latest){
    encourageBox.textContent = "ì„±ì·¨ê°€ ë¹„ì–´ ìˆì–´ìš”. í•œ ì¤„ë§Œ ì ì–´ì¤˜ìš”! ì˜ˆ: â€œë¬¼ í•œ ì»µ ë§ˆì‹¬â€";
    return;
  }

  if(state.useLLM){
    try{
      const prompt = `í•œêµ­ì–´ë¡œ, ë§¤ìš° ì§§ê³  ë”°ëœ»í•˜ê²Œ ê²©ë ¤í•´ì¤˜. ì‚¬ìš©ìì˜ ì‘ì€ ì„±ì·¨: "${latest}". í†¤: ${tone}. "ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”?" ë¬¸ì¥ì„ í¬í•¨í•´ì¤˜.`;
      const llm = await callLLM(prompt);
      encourageBox.textContent = llm;
    }catch(err){
      encourageBox.textContent = "LLM í˜¸ì¶œ ì‹¤íŒ¨ â†’ ë¡œì»¬ ê²©ë ¤ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.\n\n" + buildEncourageLocal(latest, tone);
    }
  } else {
    encourageBox.textContent = buildEncourageLocal(latest, tone);
  }
  playChime();
});

bellBtn.addEventListener("click", ()=> playChime());

randomTipBtn.addEventListener("click", ()=>{
  tipBox.textContent = pick(tips);
  playChime();
});

breathBtn.addEventListener("click", ()=> startBreathTimer());

adviceBtn.addEventListener("click", async ()=>{
  const text = stressInput.value;

  if(state.useLLM){
    try{
      const prompt = `í•œêµ­ì–´ë¡œ, ì•ˆì „í•˜ê³  ì‹¤ìš©ì ì¸ ìŠ¤íŠ¸ë ˆìŠ¤ ëŒ€ì²˜ ì¡°ì–¸ì„ 4ë‹¨ê³„ë¡œ ì œì‹œí•´ì¤˜. "ë¬´ì¡°ê±´ ê¸ì •" í†¤ì´ë˜, ë” ë‚˜ì€ ëŒ€ì•ˆì„ ë¶€ë“œëŸ½ê²Œ ì•ˆë‚´í•´ì¤˜. ìƒí™©: "${text}". "ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”?" í¬í•¨.`;
      const llm = await callLLM(prompt);
      adviceBox.textContent = llm;
    }catch(err){
      adviceBox.textContent = "LLM í˜¸ì¶œ ì‹¤íŒ¨ â†’ ë¡œì»¬ ì¡°ì–¸ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.\n\n" + buildAdviceLocal(text);
    }
  } else {
    adviceBox.textContent = buildAdviceLocal(text);
  }
  playChime();
});

clearAdviceBtn.addEventListener("click", ()=>{
  stressInput.value = "";
  adviceBox.textContent = "ì´ˆê¸°í™” ì™„ë£Œ! ì˜¤! ê·¸ ë°©ë²• ë˜ê²Œ ë‚˜ì´ìŠ¤í•œë°ìš”? ì •ë¦¬í•˜ëŠ” ê²ƒë„ íšŒë³µì˜ í•œ ë¶€ë¶„ì´ì—ìš”.";
});

// -------------------------
// Init
// -------------------------
renderAchievements();
updateKPIs();
renderQuiz();
showQuizResult();
</script>
</body>
</html>

